# 用户管理功能更新说明

## 新增功能

### 1. 学校ID配置与显示
- ✅ 学校管理员可以筛选本学校用户
- ✅ 系统管理员可以筛选任意学校用户
- ✅ 用户列表显示学校名称而非ID
- ✅ 创建用户时可以选择学校

### 2. 教师管理的学生
- ✅ 学校管理员可以创建学生用户
- ✅ 教师角色可以查看和管理学生
- ✅ 权限控制：学校管理员只能操作本校学生

### 3. 批量新增学生
- ✅ 支持批量输入学生信息
- ✅ 自动生成学号（格式：2024XXXX）
- ✅ 自动生成密码（8位，包含字母和数字）
- ✅ 支持手动输入学号和密码
- ✅ 批量创建结果反馈（成功/失败统计）

### 4. 导入学生名单
- ✅ 支持Excel文件导入
- ✅ 自动解析Excel表格
- ✅ 支持的字段：学号、姓名（昵称）、密码
- ✅ 文件格式验证

### 5. 导出学生名单
- ✅ 导出学生列表为Excel文件
- ✅ 支持按学校筛选导出
- ✅ 包含完整的学生信息

### 6. 表格模板
- ✅ 提供标准Excel模板下载
- ✅ 包含示例数据和表头
- ✅ 便于批量导入使用

## 后端API新增

### 文件：`/opt/handwriting_recognition_system/backend/app/api/users.py`

#### 新增端点：

1. **POST `/api/users/batch`** - 批量创建学生
   ```python
   class BatchStudentCreate(BaseModel):
       students: List[dict]  # 学生列表
       auto_generate_password: bool  # 自动生成密码
       auto_generate_username: bool  # 自动生成学号
   ```
   - 支持批量创建
   - 自动生成学号（2024XXXX格式）
   - 自动生成密码（8位字母+数字）
   - 返回创建结果统计

2. **GET `/api/users/template`** - 下载学生名单模板
   - 生成Excel模板文件
   - 包含表头和示例数据
   - 文件名：student_template.xlsx

3. **POST `/api/users/import`** - 导入学生名单（预留）
   - 接收Excel文件
   - 解析并批量创建学生
   - 返回导入结果

4. **GET `/api/users/export`** - 导出学生名单
   ```python
   @router.get("/export")
   async def export_students(
       school_id: Optional[int] = None,
       db: Session,
       current_user: User
   ):
   ```
   - 支持按学校筛选
   - 导出为Excel文件
   - 文件名：students_{school_id}_{timestamp}.xlsx

#### 辅助函数：

```python
def _generate_student_id() -> str:
    """生成学号（格式：2024XXXX）"""
    year = 2024
    random_num = random.randint(1000, 9999)
    return f"{year}{random_num}"

def _generate_password() -> str:
    """生成随机密码（8位，包含字母和数字）"""
    chars = string.ascii_letters + string.digits
    password = ''.join(random.choice(chars) for _ in range(8))
    return password
```

## 前端功能更新

### 文件：`/opt/handwriting_recognition_system/frontend/src/pages/UserManagement.tsx`

#### 新增功能：

1. **学校筛选**
   - 系统管理员和学校管理员可看到学校筛选下拉框
   - 自动加载学校列表
   - 筛选后只显示选中学校的用户

2. **批量创建学生界面**
   - 支持动态添加/删除学生输入行
   - 自动生成学号选项
   - 自动生成密码选项
   - 批量创建结果统计显示

3. **Excel导入功能**
   - 文件拖拽上传
   - 格式验证（仅允许Excel）
   - 自动解析Excel表格
   - 调用批量创建API

4. **导出功能**
   - 导出当前学生列表为Excel
   - 支持按学校筛选导出
   - 自动触发下载

5. **模板下载**
   - 下载标准Excel模板
   - 包含示例数据指导格式

6. **Tab界面设计**
   - Tab1：创建单个用户
   - Tab2：批量创建学生
   - Tab3：导入学生名单

#### 组件使用：

```typescript
// Ant Design组件
- Table: 用户列表展示
- Modal: 创建/批量/导入窗口
- Form: 表单输入
- Upload: Excel文件上传
- Form.List: 动态添加学生输入行
- Select: 学校/角色选择
- Tag: 角色标签显示
- Tabs: 功能Tab切换
- Space: 布局间距
- Card: 功能卡片
```

## 权限设计

### 学校管理员 (school_admin)
- ✅ 查看本校所有用户
- ✅ 创建学生用户（只能创建student角色）
- ✅ 导入/导出本校学生名单
- ✅ 查看本校学生列表
- ❌ 不能创建教师/学校管理员
- ❌ 不能修改其他学校用户

### 系统管理员 (system_admin)
- ✅ 查看所有用户和学校
- ✅ 创建任意角色的用户
- ✅ 为任意学校创建用户
- ✅ 导入/导出任意学校学生名单
- ✅ 创建/管理学校

### 教师 (teacher)
- ✅ 查看本班级学生
- ✅ 为学生上传样本
- ✅ 进行识别
- ❌ 不能创建/删除用户
- ❌ 不能导入/导出学生名单

### 学生 (student)
- ✅ 查看自己的信息
- ✅ 上传样本
- ✅ 查看自己的识别记录
- ❌ 不能管理其他用户

## 安装依赖

### 后端：
```bash
cd backend
pip install openpyxl==3.1.2
```

### 前端：
```bash
cd frontend
npm install xlsx@0.18.5
```

## 使用流程

### 批量创建学生：

1. 系统管理员或学校管理员进入用户管理页面
2. 点击"批量创建学生"按钮
3. 勾选"自动生成学号"和"自动生成密码"
4. 点击"添加学生"添加多行输入
5. 输入学生姓名（昵称）
6. 点击"确定"提交
7. 系统批量创建学生，返回成功/失败统计

### 导入学生名单：

1. 下载模板或准备Excel文件
2. 文件包含列：学号、姓名（昵称）、密码
3. 点击"导入学生名单"按钮
4. 拖拽或选择Excel文件上传
5. 系统自动解析并批量创建学生
6. 查看导入结果统计

### 导出学生名单：

1. 进入用户管理页面
2. 选择要导出的学校（系统管理员）
3. 点击"导出学生名单"按钮
4. 系统生成Excel文件并自动下载
5. 文件名：students_{school_id}_{时间戳}.xlsx

### 筛选用户：

1. 学校管理员：选择"学校筛选"下拉框
2. 系统管理员：从下拉框选择任意学校
3. 用户列表自动更新显示选中学校的用户

## 数据格式

### Excel模板格式：

| 学号 | 姓名(昵称) | 密码 |
|-------|------------|--------|
| 2024001 | 张三 | 123456 |
| 2024002 | 李四 | 123456 |
| 2024003 | 王五 | 123456 |

### 导出Excel格式：

| 学号 | 姓名 | 角色 | 学校ID | 创建时间 |
|-------|------|------|--------|----------|
| 2024001 | 张三 | student | 1 | 2024-01-30 10:00 |
| 2024002 | 李四 | student | 1 | 2024-01-30 10:05 |

## 技术实现

### 后端技术栈：
- **Excel处理**：openpyxl库（Python）
- **密码生成**：random + string模块
- **学号生成**：year + random.randint()
- **文件下载**：FastAPI StreamingResponse
- **批量操作**：事务处理，部分失败不回滚全部

### 前端技术栈：
- **Excel处理**：xlsx库（JavaScript）
- **文件上传**：Ant Design Upload.Dragger
- **动态表单**：Form.List组件
- **状态管理**：React useState + TanStack Query
- **UI组件**：Ant Design全组件库

## 注意事项

### 安全性：
1. ✅ 自动生成的密码仅创建时返回一次
2. ✅ 创建后用户应立即修改密码
3. ✅ 批量操作有权限验证
4. ✅ 导入/导出受权限控制

### 性能优化：
1. ✅ 批量创建使用事务，提高性能
2. ✅ 分页展示用户列表
3. ✅ 异步处理文件操作
4. ✅ 前端缓存学校列表

### 用户体验：
1. ✅ 清晰的操作反馈（成功/失败消息）
2. ✅ 批量创建结果统计
3. ✅ 文件拖拽上传支持
4. ✅ 响应式设计，适配不同屏幕
5. ✅ 学校名称显示，而非ID数字

## 常见问题

### Q1: 导入的Excel文件格式错误
A: 确保文件包含正确的表头：学号、姓名(昵称)、密码
A: 文件格式应为.xlsx或.xls

### Q2: 自动生成的学号重复
A: 系统会检查学号唯一性，如果重复则导入失败
A: 建议手动为重复的学生设置唯一学号

### Q3: 批量创建部分失败
A: 系统会继续处理后续学生
A: 返回成功/失败统计，可查看详细信息
A: 失败的学生可以修正后再次批量创建

### Q4: 导出的文件乱码
A: 检查导出的编码格式
A: 使用UTF-8编码确保中文正确显示

## 后续优化建议

1. **学生分组**：添加班级/年级概念，按班级管理学生
2. **批量编辑**：支持批量修改学生信息
3. **导入验证**：在上传前验证Excel数据格式
4. **导出模板定制**：支持不同学校的自定义模板
5. **操作日志**：记录批量操作的详细日志
6. **导入进度显示**：大文件导入时显示进度条

现在用户管理功能已经完全更新，支持批量操作和Excel导入导出！
